name: Destroy Infrastructure

on:
    workflow_dispatch:
        inputs:
            scope:
                description: "What to destroy: all | k8s | cluster | ecr | terraform (comma-separated). 'terraform' alone skips script phase and only runs terraform destroy."
                required: true
                default: "terraform"
            rds_id:
                description: "Optional RDS instance identifier to delete"
                required: false
            elasticache_id:
                description: "Optional ElastiCache replication group or cluster id"
                required: false
            dry_run:
                description: "Set to true to preview actions only"
                type: boolean
                default: false
            force:
                description: "Set to true to skip interactive confirmation"
                type: boolean
                default: true
            region_override:
                description: "Override AWS region (blank to use default)"
                required: false

env:
    AWS_REGION: us-east-1
    EKS_CLUSTER_NAME: voting-app-cluster

permissions:
    contents: read

jobs:
    destroy:
        name: Run destruction script
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Install eksctl
              run: |
                  curl -sSfL https://github.com/eksctl-io/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz -o eksctl.tar.gz
                  tar -xzf eksctl.tar.gz -C /tmp
                  sudo mv /tmp/eksctl /usr/local/bin
                  eksctl version

            - name: Install kubectl
              uses: azure/setup-kubectl@v3
              with:
                  version: "v1.28.0"

            - name: Ensure script executable
              run: chmod +x scripts/destroy-infra.sh

            - name: Parse scope
              id: scope
              run: |
                  SCOPE="${{ github.event.inputs.scope }}"
                  # Normalize commas & remove spaces
                  SCOPE_CLEAN=$(echo "$SCOPE" | tr 'A-Z' 'a-z' | tr -d ' ')
                  echo "scope_clean=$SCOPE_CLEAN" >> $GITHUB_OUTPUT

            - name: Build flags
              id: flags
              run: |
                  FLAGS=""
                  SCOPE="${{ steps.scope.outputs.scope_clean }}"
                  TF_FLAG="false"
                  RUN_SCRIPT="false"
                  if [[ "$SCOPE" == "all" ]]; then 
                    FLAGS="--all"
                    RUN_SCRIPT="true"
                  else
                    IFS=',' read -ra PARTS <<< "$SCOPE"
                    for part in "${PARTS[@]}"; do
                      case "$part" in
                        k8s) FLAGS+=" --k8s"; RUN_SCRIPT="true" ;;
                        cluster) FLAGS+=" --cluster"; RUN_SCRIPT="true" ;;
                        ecr) FLAGS+=" --ecr"; RUN_SCRIPT="true" ;;
                        terraform) TF_FLAG="true" ;;
                        *) echo "Ignoring unknown scope entry: $part" ;;
                      esac
                    done
                  fi
                  if [[ "${{ github.event.inputs.rds_id }}" != "" ]]; then FLAGS+=" --rds ${{ github.event.inputs.rds_id }}"; RUN_SCRIPT="true"; fi
                  if [[ "${{ github.event.inputs.elasticache_id }}" != "" ]]; then FLAGS+=" --elasticache ${{ github.event.inputs.elasticache_id }}"; RUN_SCRIPT="true"; fi
                  if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then FLAGS+=" --dry-run"; fi
                  if [[ "${{ github.event.inputs.force }}" == "true" ]]; then FLAGS+=" --force"; fi
                  if [[ "${{ github.event.inputs.region_override }}" != "" ]]; then FLAGS+=" --region ${{ github.event.inputs.region_override }}"; fi
                  echo "flags=$FLAGS" >> $GITHUB_OUTPUT
                  echo "terraform=$TF_FLAG" >> $GITHUB_OUTPUT
                  echo "run_script=$RUN_SCRIPT" >> $GITHUB_OUTPUT
                  echo "Final flags: $FLAGS (terraform destroy requested: $TF_FLAG, run script: $RUN_SCRIPT)"

            - name: Destroy infrastructure (script)
              if: steps.flags.outputs.run_script == 'true'
              env:
                  AWS_REGION: ${{ github.event.inputs.region_override || env.AWS_REGION }}
                  EKS_CLUSTER_NAME: ${{ env.EKS_CLUSTER_NAME }}
              run: |
                  echo "Running destruction with flags: ${{ steps.flags.outputs.flags }}"
                  ./scripts/destroy-infra.sh ${{ steps.flags.outputs.flags }} || exit 1

            - name: Skip script (terraform-only)
              if: steps.flags.outputs.run_script != 'true' && steps.flags.outputs.terraform == 'true'
              run: |
                  echo "Scope requested only terraform destroy; skipping script phase."

            - name: Validate scope (no actions)
              if: steps.flags.outputs.run_script != 'true' && steps.flags.outputs.terraform != 'true'
              run: |
                  echo "Error: No actionable flags provided (e.g. k8s, cluster, ecr, all, rds, elasticache)." >&2
                  exit 1

            - name: Setup Terraform
              if: steps.flags.outputs.terraform == 'true'
              uses: hashicorp/setup-terraform@v2
              with:
                  terraform_version: 1.6.0

            - name: Terraform destroy (optional)
              if: steps.flags.outputs.terraform == 'true'
              env:
                  AWS_REGION: ${{ github.event.inputs.region_override || env.AWS_REGION }}
                  EKS_CLUSTER_NAME: ${{ env.EKS_CLUSTER_NAME }}
              run: |
                  echo "Terraform destroy requested. Preparing..."
                  # STEP 0: Attempt kubeconfig (non-fatal if cluster already gone)
                  aws eks update-kubeconfig --name "$EKS_CLUSTER_NAME" --region "$AWS_REGION" || echo "(kubeconfig update failed; cluster may already be gone)"
                  # STEP 1: Delete Kubernetes ingress (releases ALB)
                  echo "[1/4] Deleting ingress voting-app-ingress (if present)"
                  kubectl delete ingress voting-app-ingress -n voting-app --ignore-not-found || true
                  # STEP 2: Attempt explicit ALB deletion (best-effort)
                  echo "[2/4] Attempting explicit ALB deletion by name voting-app-alb (ignore if not found)"
                  ALB_ARN=$(aws elbv2 describe-load-balancers --names voting-app-alb --query 'LoadBalancers[0].LoadBalancerArn' --output text 2>/dev/null || echo '')
                  if [ -n "$ALB_ARN" ] && [ "$ALB_ARN" != "None" ]; then
                    echo "Found ALB ARN: $ALB_ARN - deleting..."
                    aws elbv2 delete-load-balancer --load-balancer-arn "$ALB_ARN" || echo "(ALB delete failed - may already be deleting)"
                  else
                    echo "No ALB named voting-app-alb found (may already be deleting or different name)."
                  fi
                  # STEP 3: Wait for network interfaces to be released
                  echo "[3/4] Waiting 30s for ALB ENIs to detach..."
                  sleep 30
                  # STEP 4: Run Terraform destroy / plan
                  echo "[4/4] Executing Terraform phase"
                  cd terraform
                  terraform init -input=false
                  if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
                    echo "Dry run enabled - showing destroy plan only."
                    terraform plan -destroy -var=environment=dev || exit 1
                  else
                    terraform destroy -auto-approve -var=environment=dev || exit 1
                  fi
                  echo "Terraform phase complete."

            - name: Summary
              if: always()
              run: |
                  echo "### Destroy Infra Run" >> $GITHUB_STEP_SUMMARY
                  echo "Scope: ${{ github.event.inputs.scope }}" >> $GITHUB_STEP_SUMMARY
                  echo "Region: ${{ github.event.inputs.region_override || env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
                  echo "RDS: ${{ github.event.inputs.rds_id || 'none' }}" >> $GITHUB_STEP_SUMMARY
                  echo "ElastiCache: ${{ github.event.inputs.elasticache_id || 'none' }}" >> $GITHUB_STEP_SUMMARY
                  echo "Dry run: ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
                  echo "Force: ${{ github.event.inputs.force }}" >> $GITHUB_STEP_SUMMARY
                  echo "Flags: ${{ steps.flags.outputs.flags }}" >> $GITHUB_STEP_SUMMARY
                  echo "Terraform requested: ${{ steps.flags.outputs.terraform }}" >> $GITHUB_STEP_SUMMARY
